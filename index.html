<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PetOS - Pet Operating System</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tahoma&display=swap');
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      font-family: Tahoma, Arial, sans-serif;
      background: #3a6ea5;
      color: #000;
      overflow: hidden;
      height: 100vh;
      user-select: none;
      cursor: auto;
    }
    
    .desktop {
      position: relative;
      height: 100vh;
      background: linear-gradient(to bottom, #3a6ea5 0%, #1e4788 100%);
      animation: desktopGlow 20s ease-in-out infinite;
    }
    
    @keyframes desktopGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.1); }
    }
    
    /* Desktop Icons */
    .desktop-icon {
      position: absolute;
      width: 80px;
      padding: 4px;
      text-align: center;
      cursor: pointer;
      transition: all 0.1s;
    }
    
    .desktop-icon:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    .desktop-icon:active {
      transform: scale(0.95);
    }
    
    .icon-image {
      width: 48px;
      height: 48px;
      margin: 0 auto 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5));
    }
    
    .icon-label {
      font-size: 11px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      line-height: 1.2;
      word-wrap: break-word;
    }
    
    /* Window Styles */
    .window {
      position: fixed;
      background: #ece9d8;
      border: 3px solid;
      border-color: #fff #87875d #87875d #fff;
      box-shadow: inset -1px -1px #cbc7b8, inset 1px 1px #ffffff, 2px 2px 5px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      min-width: 250px;
    }
    
    .window.active {
      display: block;
      animation: windowOpen 0.2s ease-out;
    }
    
    @keyframes windowOpen {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .window-header {
      background: linear-gradient(to right, #245ddb 0%, #3c7fe5 50%, #245ddb 100%);
      padding: 2px 3px 3px 3px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: move;
    }
    
    .window-title {
      color: #fff;
      font-size: 11px;
      font-weight: bold;
      text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    
    .title-icon {
      width: 16px;
      height: 16px;
    }
    
    .window-controls {
      display: flex;
      gap: 2px;
    }
    
    .window-button {
      width: 21px;
      height: 21px;
      border: 2px solid;
      border-color: #fff #87875d #87875d #fff;
      background: #ece9d8;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Marlett, sans-serif;
      font-size: 12px;
      padding: 0;
    }
    
    .window-button:hover {
      background: #ddd4b8;
    }
    
    .window-button:active {
      border-color: #87875d #fff #fff #87875d;
      padding-left: 1px;
      padding-top: 1px;
    }
    
    .window.minimized {
      display: none;
    }
    
    .window-content {
      padding: 8px;
      overflow-y: auto;
      max-height: calc(100vh - 120px);
    }
    
    /* Main App Window */
    #mainWindow {
      width: 500px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* Form Styles */
    .input-group {
      margin-bottom: 12px;
    }
    
    .input-group label {
      display: block;
      font-size: 11px;
      margin-bottom: 4px;
      font-weight: bold;
    }
    
    .text-input {
      width: 100%;
      padding: 3px 4px;
      border: 2px solid;
      border-color: #87875d #fff #fff #87875d;
      background: #fff;
      font-family: Tahoma, Arial, sans-serif;
      font-size: 11px;
    }
    
    .text-input:focus {
      outline: 1px dotted #000;
      outline-offset: -3px;
    }
    
    /* Button Styles */
    .button {
      padding: 5px 14px;
      border: 2px solid;
      border-color: #fff #87875d #87875d #fff;
      background: #ece9d8;
      font-family: Tahoma, Arial, sans-serif;
      font-size: 11px;
      cursor: pointer;
      min-width: 75px;
    }
    
    .button:hover {
      background: #ddd4b8;
    }
    
    .button:active {
      border-color: #87875d #fff #fff #87875d;
      padding-left: 15px;
      padding-top: 6px;
    }
    
    .button:disabled {
      color: #8b8b8b;
      cursor: default;
      text-shadow: 1px 1px 0 #fff;
    }
    
    .button:disabled:active {
      border-color: #fff #87875d #87875d #fff;
      padding-left: 14px;
      padding-top: 5px;
    }
    
    /* Progress Bar */
    .progress-container {
      height: 20px;
      border: 2px solid;
      border-color: #87875d #fff #fff #87875d;
      background: #fff;
      padding: 2px;
      margin: 8px 0;
    }
    
    .progress-bar {
      height: 100%;
      background-image: repeating-linear-gradient(
        90deg,
        #245ddb,
        #245ddb 8px,
        #3c7fe5 8px,
        #3c7fe5 16px
      );
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Status Text */
    .status-text {
      font-size: 11px;
      margin: 8px 0;
      padding: 4px;
      background: #fff;
      border: 1px solid #87875d;
      min-height: 18px;
      color: #245ddb;
      font-style: italic;
    }
    
    .error-text {
      color: #ff0000;
      font-style: normal;
      font-weight: bold;
    }
    
    /* Pet Display */
    .pet-container {
      background: #fff;
      border: 2px solid;
      border-color: #87875d #fff #fff #87875d;
      padding: 8px;
      margin-top: 12px;
      display: none;
    }
    
    .pet-viewer {
      width: 100%;
      height: 300px;
      margin: 0 auto 12px;
      border: 1px solid #87875d;
      background: linear-gradient(to bottom, #e3f4ff 0%, #b3d9ff 100%);
      position: relative;
      overflow: hidden;
      cursor: grab;
    }
     .pet-viewer:active {
      cursor: grabbing;
    }
    
    #petCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    
    .pet-info {
      border: 1px solid #87875d;
      padding: 8px;
      margin-top: 8px;
      background: #f9f7ed;
    }
    
    .pet-name {
      font-size: 14px;
      font-weight: bold;
      color: #245ddb;
      text-align: center;
      margin-bottom: 8px;
    }
    
    .pet-stats {
      display: grid;
      grid-template-columns: 1fr;
      gap: 4px;
      font-size: 11px;
    }
    
    .stat-row {
      display: grid;
      grid-template-columns: 100px 1fr;
      padding: 2px 0;
      border-bottom: 1px dotted #ccc;
    }
    
    .stat-label {
      font-weight: bold;
      color: #87875d;
    }
    
    /* Rarity Styles */
    .rarity-common { color: #808080; }
    .rarity-uncommon { color: #1eff00; text-shadow: 0 0 2px #000; }
    .rarity-rare { color: #0080ff; text-shadow: 0 0 2px #000; }
    .rarity-epic { color: #a335ee; text-shadow: 0 0 2px #000; }
    .rarity-legendary { color: #ff8000; text-shadow: 0 0 2px #000; }
    .rarity-mythic { 
      background: linear-gradient(45deg, #ff0080, #00ff80, #0080ff, #ff0080);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: mythicGlow 3s ease infinite;
    }
    
    @keyframes mythicGlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Share Buttons */
    .share-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: center;
    }
    
    /* Taskbar */
    .taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30px;
      background: #ece9d8;
      border-top: 2px solid #fff;
      display: flex;
      align-items: center;
      padding: 0 2px;
      z-index: 9999;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.2);
    }
    
    .start-button {
      height: 24px;
      padding: 0 8px;
      border: 2px solid;
      border-color: #fff #87875d #87875d #fff;
      background: #ece9d8;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .start-button:hover {
      background: #ddd4b8;
    }
    
    .start-button:active {
      border-color: #87875d #fff #fff #87875d;
    }
    
    .windows-logo {
      width: 16px;
      height: 14px;
      background: linear-gradient(45deg, #ff0000 25%, #00ff00 25%, #00ff00 50%, #0000ff 50%, #0000ff 75%, #ffff00 75%);
      border: 1px solid #000;
    }
    
    .taskbar-clock {
      margin-left: auto;
      padding: 0 8px;
      font-size: 11px;
      border: 1px solid;
      border-color: #87875d #fff #fff #87875d;
      height: 22px;
      display: flex;
      align-items: center;
    }
    
    /* Notification Area */
    .notification {
      position: fixed;
      bottom: 40px;
      right: 10px;
      background: #ffffcc;
      border: 1px solid #000;
      padding: 8px;
      font-size: 11px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      display: none;
      max-width: 200px;
      z-index: 10000;
      animation: notificationPop 0.3s ease-out;
    }
    
    @keyframes notificationPop {
      from {
        transform: scale(0.8) translateY(20px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }
    
    .notification-title {
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    /* Help/About Windows */
    #helpWindow, #aboutWindow {
      top: 100px;
      left: 150px;
    }
    
    .about-content {
      text-align: center;
      padding: 20px;
    }
    
    .about-logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 12px;
      background: #ffd700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    
    .warning-text {
      color: #ff0000;
      font-weight: bold;
      font-size: 10px;
      margin-top: 4px;
      text-align: center;
      animation: blink 1s ease-in-out infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .start-menu {
      font-family: Tahoma, Arial, sans-serif;
      font-size: 12px;
      border-radius: 3px;
      overflow: hidden;
      animation: menuPop 0.15s ease;
    }
    .start-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      border-bottom: 1px solid #e0dcc7;
      transition: background 0.15s;
      user-select: none;
    }
    .start-menu-item:last-child {
      border-bottom: none;
    }
    .start-menu-item:hover:not([style*='color:#aaa']) {
      background: #d6cfa7;
    }
    @keyframes menuPop {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .taskbar-items {
      display: flex;
      gap: 2px;
      margin-left: 4px;
      height: 100%;
      align-items: center;
      overflow: hidden;
    }

    .taskbar-item {
        height: 24px;
        padding: 0 8px;
        border: 2px solid;
        border-color: #fff #87875d #87875d #fff;
        background: #ece9d8;
        font-size: 11px;
        cursor: pointer;
        display: flex;
        align-items: center;
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .taskbar-item.active {
       border-color: #87875d #fff #fff #87875d;
       background: #d6cfa7;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        padding: 8px;
    }
    .gallery-item {
        border: 2px solid;
        border-color: #fff #87875d #87875d #fff;
        background: #f9f7ed;
        padding: 8px;
        text-align: center;
        cursor: pointer;
        transition: background 0.15s;
    }
    .gallery-item:hover {
        background: #d6cfa7;
    }
    .gallery-item-name {
        font-size: 11px;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
    }
    .gallery-item-rarity {
        font-size: 10px;
    }
  </style>
</head>
<body>
  <div class="desktop">
    <!-- Desktop Icons -->
    <div class="desktop-icon" style="top: 20px; left: 20px;" ondblclick="openMainWindow()">
      <div class="icon-image">
        <svg width="48" height="48" viewBox="0 0 48 48">
          <ellipse cx="24" cy="32" rx="14" ry="10" fill="#ffd700" stroke="#c7a100" stroke-width="2"/>
          <ellipse cx="15" cy="18" rx="5" ry="6" fill="#ffd700" stroke="#c7a100" stroke-width="1.5"/>
          <ellipse cx="25" cy="14" rx="5" ry="6" fill="#ffd700" stroke="#c7a100" stroke-width="1.5"/>
          <ellipse cx="35" cy="18" rx="5" ry="6" fill="#ffd700" stroke="#c7a100" stroke-width="1.5"/>
        </svg>
      </div>
      <div class="icon-label">PetOS.SYS</div>
    </div>
    
    <div class="desktop-icon" style="top: 110px; left: 20px;" ondblclick="openHelpWindow()">
      <div class="icon-image">
        <svg width="48" height="48" viewBox="0 0 48 48">
          <rect x="8" y="8" width="32" height="32" rx="2" fill="#fff" stroke="#245ddb" stroke-width="2"/>
          <text x="24" y="30" text-anchor="middle" font-size="24" font-weight="bold" fill="#245ddb">?</text>
        </svg>
      </div>
      <div class="icon-label">Help</div>
    </div>
    
    <div class="desktop-icon" style="top: 200px; left: 20px;" ondblclick="openAboutWindow()">
      <div class="icon-image">
        <svg width="48" height="48" viewBox="0 0 48 48">
          <circle cx="24" cy="24" r="20" fill="#245ddb" stroke="#fff" stroke-width="2"/>
          <text x="24" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#fff">i</text>
        </svg>
      </div>
      <div class="icon-label">About</div>
    </div>
    
    <div class="desktop-icon" style="top: 290px; left: 20px;" ondblclick="window.open('https://x.com/Ducklabsxyz', '_blank')">
      <div class="icon-image">
        <svg width="48" height="48" viewBox="0 0 48 48">
          <rect x="8" y="8" width="32" height="32" rx="4" fill="#000" stroke="#fff" stroke-width="2"/>
          <path d="M 12 12 L 36 36 M 36 12 L 12 36" stroke="#fff" stroke-width="3"/>
        </svg>
      </div>
      <div class="icon-label">X.com</div>
    </div>

    <div class="desktop-icon" style="top: 380px; left: 20px;" ondblclick="openGalleryWindow()">
      <div class="icon-image">
        <svg width="48" height="48" viewBox="0 0 48 48">
            <path d="M40,12H24l-4-4H8c-2.2,0-4,1.8-4,4v24c0,2.2,1.8,4,4,4h32c2.2,0,4-1.8,4-4V16C44,13.8,42.2,12,40,12z" fill="#FFC107"/>
            <ellipse cx="28" cy="29" rx="8" ry="6" fill="#ffd700" stroke="#ff8c00" stroke-width="1"/>
            <circle cx="28" cy="23" r="6" fill="#ffd700" stroke="#ff8c00" stroke-width="1"/>
            <circle cx="26" cy="22" r="1" fill="#000"/>
            <circle cx="30" cy="22" r="1" fill="#000"/>
        </svg>
      </div>
      <div class="icon-label">My Pets</div>
    </div>

    <div class="desktop-icon" style="top: 470px; left: 20px;" ondblclick="openRoadmapWindow()">
        <div class="icon-image">
            <svg width="48" height="48" viewBox="0 0 48 48">
                <path d="M40 8H8c-2.2 0-4 1.8-4 4v24c0 2.2 1.8 4 4 4h32c2.2 0 4-1.8 4-4V12c0-2.2-1.8-4-4-4zm0 28H8V12h32v24z" fill="#FFC107"/>
                <path d="M12 18h12v4H12zM12 26h24v4H12zM28 18h8v4h-8z" fill="#006400"/>
            </svg>
        </div>
        <div class="icon-label">$PET Roadmap</div>
    </div>

    <!-- Main Window -->
    <div class="window" id="mainWindow">
      <div class="window-header" onmousedown="startDrag(event, 'mainWindow')">
        <div class="window-title">
          <img src="data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 48 48' xmlns='http://www.w3.org/2000/svg'%3E%3Cellipse cx='24' cy='32' rx='14' ry='10' fill='%23ffd700'/%3E%3Cellipse cx='15' cy='18' rx='5' ry='6' fill='%23ffd700'/%3E%3Cellipse cx='25' cy='14' rx='5' ry='6' fill='%23ffd700'/%3E%3Cellipse cx='35' cy='18' rx='5' ry='6' fill='%23ffd700'/%3E%3C/svg%3E" class="title-icon">
          PetOS
        </div>
        <div class="window-controls">
          <button class="window-button" onclick="minimizeWindow('mainWindow')">_</button>
          <button class="window-button" onclick="closeWindow('mainWindow')">‚úï</button>
        </div>
      </div>
      <div class="window-content">
        <div style="background: #fff; border: 1px solid #87875d; padding: 8px; margin-bottom: 12px;">
          <strong>Pet Operating System</strong><br>
          <small>‚ö†Ô∏è WARNING: Each user is allocated ONE pet kernel. Choose wisely!</small>
        </div>
        
        <div class="input-group">
          <label>Wallet Status:</label>
          <div id="walletAddressDisplay" class="status-text" style="font-style: normal; padding: 6px; text-align: center;">Not Connected</div>
        </div>
        
        <div style="text-align: center; margin: 12px 0;">
          <button class="button" id="generateBtn" onclick="generatePet()" disabled>
            Initialize PetOS
          </button>
        </div>
        
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="status-text" id="statusText">Awaiting initialization...</div>
        
        <div class="pet-container" id="petContainer">
          <div class="pet-viewer" id="petViewer">
            <canvas id="petCanvas"></canvas>
          </div>
          <div class="pet-info" id="petInfo"></div>
          <div class="share-buttons">
            <button class="button" onclick="sharePet()">Share on X</button>
            <button class="button" onclick="copyPetData()">Copy Data</button>
            <button class="button" onclick="downloadPetImage()">Save .PNG</button>
            <button class="button" onclick="sharePetCard()">Share Card</button>
            <button class="button" onclick="triggerInteraction()">Interact</button>
          </div>
        </div>
        
        <div class="warning-text" id="warningText" style="display: none;">
          ‚ö†Ô∏è KERNEL ALREADY ALLOCATED - NO REGENERATION POSSIBLE ‚ö†Ô∏è
        </div>
      </div>
    </div>

    <!-- My Pets Gallery Window -->
    <div class="window" id="galleryWindow" style="width: 450px; height: 350px; top: 120px; left: 200px;">
      <div class="window-header" onmousedown="startDrag(event, 'galleryWindow')">
        <div class="window-title">
          <img src="data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 48 48' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M40,12H24l-4-4H8c-2.2,0-4,1.8-4,4v24c0,2.2,1.8,4,4,4h32c2.2,0,4-1.8,4-4V16C44,13.8,42.2,12,40,12z' fill='%23FFC107'/%3E%3Cellipse cx='28' cy='29' rx='8' ry='6' fill='%23ffd700' stroke='%23ff8c00' stroke-width='1.5'/%3E%3Ccircle cx='28' cy='23' r='6' fill='%23ffd700' stroke='%23ff8c00' stroke-width='1.5'/%3E%3C/svg%3E" class="title-icon">
          My Pets
        </div>
        <div class="window-controls">
          <button class="window-button" onclick="minimizeWindow('galleryWindow')">_</button>
          <button class="window-button" onclick="closeWindow('galleryWindow')">‚úï</button>
        </div>
      </div>
      <div class="window-content" id="galleryContent" style="max-height: 300px;">
        <!-- Pet items will be injected here -->
      </div>
    </div>

    <!-- Help Window -->
    <div class="window" id="helpWindow">
      <div class="window-header" onmousedown="startDrag(event, 'helpWindow')">
        <div class="window-title">
          <img src="data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='2' y='2' width='12' height='12' fill='%23fff' stroke='%23245ddb'/%3E%3Ctext x='8' y='11' text-anchor='middle' font-size='10' fill='%23245ddb'%3E?%3C/text%3E%3C/svg%3E" class="title-icon">
          PetOS Help
        </div>
        <div class="window-controls">
          <button class="window-button" onclick="minimizeWindow('helpWindow')">_</button>
          <button class="window-button" onclick="closeWindow('helpWindow')">‚úï</button>
        </div>
      </div>
      <div class="window-content">
        <h3>PetOS System Manual</h3>
        <p><strong>What is PetOS?</strong><br>
        Pet Operating System - A revolutionary digital pet companion system.</p>
        
        <p><strong>How to Use:</strong><br>
        1. Open PetOS.SYS from the desktop.<br>
        2. Connect your Solana wallet.<br>
        3. You must be holding the $PET token to generate a pet.<br>
        4. Click "Initialize PetOS"<br>
        5. Your unique pet will be generated based on your wallet address.<br>
        6. <span style="color: red;">WARNING: One pet per wallet FOREVER!</span></p>
        
        <p><strong>Pet Rarity Tiers:</strong><br>
        ‚Ä¢ Common (Gray) - 40%<br>
        ‚Ä¢ Uncommon (Green) - 30%<br>
        ‚Ä¢ Rare (Blue) - 15%<br>
        ‚Ä¢ Epic (Purple) - 10%<br>
        ‚Ä¢ Legendary (Orange) - 4.5%<br>
        ‚Ä¢ Mythic (Rainbow) - 0.5%</p>
      </div>
    </div>

    <!-- About Window -->
    <div class="window" id="aboutWindow">
      <div class="window-header" onmousedown="startDrag(event, 'aboutWindow')">
        <div class="window-title">
          <img src="data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='8' cy='8' r='6' fill='%23245ddb'/%3E%3Ctext x='8' y='11' text-anchor='middle' font-size='10' fill='%23fff'%3Ei%3C/text%3E%3C/svg%3E" class="title-icon">
          About PetOS
        </div>
        <div class="window-controls">
          <button class="window-button" onclick="minimizeWindow('aboutWindow')">_</button>
          <button class="window-button" onclick="closeWindow('aboutWindow')">‚úï</button>
        </div>
      </div>
      <div class="window-content">
        <div class="about-content">
          <div class="about-logo">üêæ</div>
          <h3>PetOS</h3>
          <p>Pet Operating System</p>
          <p style="font-size: 10px; color: #666;">
            Licensed to: UNREGISTERED<br>
            Serial: PET-XXXX-XXXX-XXXX
          </p>
        </div>
      </div>
    </div>

    <!-- Connect Wallet Window -->
    <div class="window" id="connectWalletWindow" style="width: 320px; top: 150px; left: 150px;">
      <div class="window-header" onmousedown="startDrag(event, 'connectWalletWindow')">
        <div class="window-title">
          <img src="data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='2' y='4' width='12' height='9' rx='1' fill='%23666'/%3E%3Crect x='3' y='5' width='10' height='7' fill='%23fff'/%3E%3Ccircle cx='11' cy='8' r='1' fill='%23666'/%3E%3C/svg%3E" class="title-icon">
          Wallet Required
        </div>
        <div class="window-controls">
          <button class="window-button" onclick="closeWindow('connectWalletWindow')">‚úï</button>
        </div>
      </div>
      <div class="window-content" style="text-align: center; padding: 16px;">
        <p style="font-size: 11px; margin-bottom: 16px;">To generate a Pet, you need to connect your Solana wallet and hold the $PET token.</p>
        <button class="button" onclick="connectWallet()">Connect Wallet</button>
      </div>
    </div>
  </div>

  <!-- $PET Roadmap Window -->
    <div class="window" id="roadmapWindow" style="width: 400px; top: 180px; left: 250px;">
        <div class="window-header" onmousedown="startDrag(event, 'roadmapWindow')">
            <div class="window-title">
                <img src="data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M14 2H2v12h12V2zM3 13V3h10v10H3z' fill='%23FFC107'/%3E%3Cpath d='M4 4h8v2H4zm0 3h8v2H4zm0 3h5v2H4z' fill='%23006400'/%3E%3C/svg%3E" class="title-icon">
                $PET Token Roadmap
            </div>
            <div class="window-controls">
                <button class="window-button" onclick="minimizeWindow('roadmapWindow')">_</button>
                <button class="window-button" onclick="closeWindow('roadmapWindow')">‚úï</button>
            </div>
        </div>
        <div class="window-content" style="padding: 12px; font-size: 11px;">
            <h3 style="text-align: center; margin-bottom: 8px;">Holder Incentives & Roadmap</h3>
            <p>Holding the <strong>$PET</strong> token grants you exclusive benefits within the PetOS ecosystem.</p>
            <br>
            <h4 style="margin-bottom: 4px;">Phase 1: Foundation</h4>
            <ul style="margin-left: 18px; padding-left: 0;">
                <li style="margin-bottom: 4px;"><strong>Creator Fee Distribution:</strong> 50% of creator fees from secondary market sales will be airdropped to $PET holders.</li>
                <li><strong>Community Access:</strong> Exclusive access to a token-gated community channel.</li>
            </ul>
            <h4 style="margin-top: 12px; margin-bottom: 4px;">Phase 2: Evolution</h4>
            <ul style="margin-left: 18px; padding-left: 0;">
                <li style="margin-bottom: 4px;"><strong>Mint Your Pet NFT:</strong> $PET holders will be the first to mint their generated Pet as a permanent NFT on Solana.</li>
                <li><strong>Pet Customization:</strong> Unlock special accessories and traits for your Pet available only to holders.</li>
            </ul>
            <h4 style="margin-top: 12px; margin-bottom: 4px;">Phase 3: Expansion</h4>
            <ul style="margin-left: 18px; padding-left: 0;">
                <li style="margin-bottom: 4px;"><strong>PetOS V2:</strong> Holders will get early access to the next generation of PetOS features, including pet interactions and mini-games.</li>
                <li><strong>Governance:</strong> Participate in decisions about the future of PetOS.</li>
            </ul>
            <br>
            <p style="text-align:center; font-style:italic;">More to be announced soon!</p>
        </div>
    </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <button class="start-button" id="startButton">
      <div class="windows-logo"></div>
      Start
    </button>
    <div class="taskbar-items" id="taskbarItems"></div>
    <div class="taskbar-clock" id="clock">12:00 PM</div>
  </div>

  <!-- Start Menu -->
  <div class="start-menu" id="startMenu" style="display:none; position:fixed; left:2px; bottom:32px; min-width:160px; background:#ece9d8; border:2px solid #fff; box-shadow:2px 2px 8px rgba(0,0,0,0.2); z-index:10001;">
    <div class="start-menu-item" onclick="openMainWindow(); hideStartMenu();">üêæ PetOS.SYS</div>
    <div class="start-menu-item" onclick="openGalleryWindow(); hideStartMenu();">üñºÔ∏è My Pets</div>
    <div class="start-menu-item" onclick="openRoadmapWindow(); hideStartMenu();">üó∫Ô∏è $PET Roadmap</div>
    <div class="start-menu-item" onclick="openHelpWindow(); hideStartMenu();">‚ùì Help</div>
    <div class="start-menu-item" onclick="openAboutWindow(); hideStartMenu();">‚ÑπÔ∏è About</div>
    <div class="start-menu-item" style="color:#aaa; cursor:default;">‚öôÔ∏è Settings (soon)</div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <div class="notification-title">PetOS</div>
    <div id="notificationText">Ready</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script>
    // --- GLOBAL STATE & CONFIG ---
    let currentPetData = null;
    const petRegistry = JSON.parse(localStorage.getItem('petRegistry') || '{}'); // Store generated pets by wallet
    let solanaConnection = null;
    let connectedWallet = null;

    // The mint address of the Pump.fun token.
    // IMPORTANT: REPLACE THIS WITH YOUR ACTUAL TOKEN MINT ADDRESS AFTER LAUNCH.
    const PUMP_FUN_TOKEN_MINT = 'YOUR_PUMP_FUN_TOKEN_MINT_ADDRESS_HERE';

    // Three.js variables
    let scene, camera, renderer, petGroup;
    let animationId;
    let isDragging = false;
    let previousMousePosition = { x: 0, y: 0 };
    
    // Window management
    let zCounter = 1001;
    let petIsHopping = false;
    let hopStartTime = 0;


    // --- UI ELEMENT REFERENCES ---
    const ui = {
        mainWindow: document.getElementById('mainWindow'),
        helpWindow: document.getElementById('helpWindow'),
        aboutWindow: document.getElementById('aboutWindow'),
        roadmapWindow: document.getElementById('roadmapWindow'),
        connectWalletWindow: document.getElementById('connectWalletWindow'),
        walletAddressDisplay: document.getElementById('walletAddressDisplay'),
        generateBtn: document.getElementById('generateBtn'),
        progressBar: document.getElementById('progressBar'),
        statusText: document.getElementById('statusText'),
        petContainer: document.getElementById('petContainer'),
        petInfo: document.getElementById('petInfo'),
        petCanvas: document.getElementById('petCanvas'),
        petViewer: document.getElementById('petViewer'),
        warningText: document.getElementById('warningText'),
        clock: document.getElementById('clock'),
        notification: document.getElementById('notification'),
        notificationText: document.getElementById('notificationText'),
        taskbarItems: document.getElementById('taskbarItems'),
        galleryWindow: document.getElementById('galleryWindow'),
        galleryContent: document.getElementById('galleryContent'),
    };
    
    // --- SOUNDS ---
    const sounds = {
        click: new Audio("data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQQAAAAA//8CAP//"),
        success: new Audio("data:audio/wav;base64," +
            "UklGRlQDAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YUwDAABAgICAgICAgICAgICAgICAgIAAgP+A/4D/gP+A/4D/gACAgICAgICAgICAgICAgICAgICAgICAgICA" +
            "gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgACAAIAAgAEAAQACAAIAAgACAAQACAAEAAgACAAQABAAEAAgACAAQABAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAE" +
            "AAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgAC" +
            "AAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAE" +
            "AAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgAC" +
            "AAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +

            "AAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgAC" +
            "AAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +

            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            "ACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAgACAAEAAg" +
            ""),
        interaction: new Audio("data:audio/wav;base64," +
            "UklGRlAAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYAAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA" +
            "gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            "ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" +
            ""),
        play: function(soundName) {
            const sound = this[soundName];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => { /* Autoplay may be blocked, ignore */ });
            }
        }
    };
    
    // --- PET ATTRIBUTES (v1.0) ---
    const petAttributes = {
        rarities: [
            { name: 'Common', chance: 0.40, color: 0x9E9E9E },
            { name: 'Uncommon', chance: 0.30, color: 0x4CAF50 },
            { name: 'Rare', chance: 0.15, color: 0x2196F3 },
            { name: 'Epic', chance: 0.10, color: 0x9C27B0 },
            { name: 'Legendary', chance: 0.045, color: 0xFF9800 },
            { name: 'Mythic', chance: 0.005, color: 'rainbow' }
        ],
        bodyShapes: ["Blob", "Critter", "Wyrm"],
        accessories: ["None", "Top Hat", "Wizard Hat", "Crown", "Headphones", "Sunglasses", "Bowtie", "Monocle", "Halo", "Devil Horns", "Jetpack"],
        personalities: ["Debugger", "Helper", "Listener", "Advisor", "Companion", "Guardian", "Scholar", "Sage", "Oracle", "Mentor"],
        specialTraits: ["None", "Glowing Eyes", "Sparkles", "Floating", "Code Aura", "Glitching", "Stealth"]
    };


    // --- SOLANA & WALLET LOGIC ---

    function openConnectWalletWindow() {
        const win = ui.connectWalletWindow;
        win.classList.add('active');
        win.classList.remove('minimized');
        bringToFront(win);
        sounds.play('click');
    }

    async function connectWallet() {
        if ('solana' in window) {
            const provider = window.solana;
            if (provider.isPhantom) { // Or other wallet providers
                try {
                    const resp = await provider.connect();
                    connectedWallet = resp.publicKey;
                    ui.walletAddressDisplay.textContent = `Connected: ${connectedWallet.toString().substring(0, 4)}...${connectedWallet.toString().substring(connectedWallet.toString().length - 4)}`;
                    ui.generateBtn.disabled = false;
                    showNotification('Wallet connected successfully!');
                    closeWindow('connectWalletWindow');

                    // Initialize Solana connection
                    solanaConnection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));

                } catch (err) {
                    showError('Wallet connection failed.');
                    console.error(err);
                }
            }
        } else {
            showError('Solana wallet not found! Please install Phantom.');
            window.open('https://phantom.app/', '_blank');
        }
    }

    async function checkTokenOwnership(walletAddress) {
        ui.statusText.textContent = 'Verifying token ownership...';
        ui.progressBar.style.width = `5%`;

        if (PUMP_FUN_TOKEN_MINT === 'YOUR_PUMP_FUN_TOKEN_MINT_ADDRESS_HERE') {
            showError("Project owner has not configured the token mint address yet.");
            console.error("Please replace 'YOUR_PUMP_FUN_TOKEN_MINT_ADDRESS_HERE' in the script.");
            return false;
        }
        
        try {
            const publicKey = new solanaWeb3.PublicKey(walletAddress);
            const tokenAccounts = await solanaConnection.getParsedTokenAccountsByOwner(
                publicKey, 
                { mint: new solanaWeb3.PublicKey(PUMP_FUN_TOKEN_MINT) }
            );

            if (tokenAccounts.value.length > 0) {
                for (const account of tokenAccounts.value) {
                    const amount = account.account.data.parsed.info.tokenAmount.uiAmount;
                    if (amount > 0) {
                        ui.statusText.textContent = 'Token ownership verified!';
                        return true;
                    }
                }
            }
            
            return false;
        } catch (error) {
            console.error("Error checking token ownership:", error);
            showError("Could not verify token ownership.");
            return false;
        }
    }


    // --- CORE LOGIC ---

    /**
     * Main function to generate a pet based on user input.
     */
    async function generatePet() {
        if (!connectedWallet || !solanaConnection) {
            showError("Please connect your wallet first.");
            openConnectWalletWindow();
            return;
        }

        const walletAddress = connectedWallet.toString();

        if (petRegistry[walletAddress]) {
            showError(`Pet for this wallet already exists.`);
            displayPet(petRegistry[walletAddress]);
            ui.generateBtn.disabled = true; // Disable after generating
            return;
        }

        const hasToken = await checkTokenOwnership(walletAddress);
        if (!hasToken) {
            showError("You must hold the $PET token to generate a pet.");
            return;
        }

        ui.generateBtn.disabled = true;
        ui.petContainer.style.display = 'none';

        const steps = [
            { progress: 10, text: "Connecting to PetOS mainframe..." },
            { progress: 25, text: "Hashing wallet into unique identifier..." },
            { progress: 40, text: `Allocating kernel for ${walletAddress.substring(0,10)}...` },
            { progress: 50, text: "Determining body shape and rarity..." },
            { progress: 70, text: "Assigning random accessories and traits..." },
            { progress: 85, text: "Fabricating 3D pet model..." },
            { progress: 95, text: "Finalizing companion parameters..." },
            { progress: 100, text: "Initialization complete!" }
        ];

        for (const step of steps) {
            await updateProgress(step.progress, step.text);
        }

        const seed = simpleHash(walletAddress);
        const petData = createPetData(walletAddress, seed);
        petRegistry[walletAddress] = petData;
        localStorage.setItem('petRegistry', JSON.stringify(petRegistry));
        currentPetData = petData;

        displayPet(petData);
        
        showNotification(`Your PetOS pet for ${walletAddress.substring(0,10)}... is ready!`);
        sounds.play('success');
    }
    
    /**
     * Creates a deterministic set of pet properties from a seed.
     */
    function createPetData(walletAddress, seed) {
        let i = 0;
        const seededRandom = () => {
            const x = Math.sin(seed + i++) * 10000;
            return x - Math.floor(x);
        };

        let rarityRoll = seededRandom();
        let cumulativeChance = 0;
        let rarity = petAttributes.rarities[0];
        for (const r of petAttributes.rarities) {
            cumulativeChance += r.chance;
            if (rarityRoll < cumulativeChance) {
                rarity = r;
                break;
            }
        }
        
        const hasAccessory = seededRandom() > 0.3;
        const hasSpecialTrait = rarityRoll > 0.9;
        
        let bodyShape = petAttributes.bodyShapes[Math.floor(seededRandom() * petAttributes.bodyShapes.length)];
        let specialTrait = hasSpecialTrait ? petAttributes.specialTraits[Math.floor(seededRandom() * petAttributes.specialTraits.length)] : 'None';
        
        return {
            walletAddress: walletAddress,
            name: `${walletAddress.substring(0, 6)}'s Pet`,
            seed: seed,
            rarity: rarity,
            bodyShape: bodyShape,
            accessory: hasAccessory ? petAttributes.accessories[Math.floor(seededRandom() * petAttributes.accessories.length)] : 'None',
            personality: petAttributes.personalities[Math.floor(seededRandom() * petAttributes.personalities.length)],
            specialTrait: specialTrait,
        };
    }
    
    /**
     * Displays the generated pet's info and 3D model.
     */
    function displayPet(petData) {
        ui.petContainer.style.display = 'block';

        const rarityClass = `rarity-${petData.rarity.name.toLowerCase()}`;
        ui.petInfo.innerHTML = `
            <div class="pet-name">${petData.name}</div>
            <div class="pet-stats">
                <div class="stat-row">
                    <span class="stat-label">Rarity:</span>
                    <span class="stat-value ${rarityClass}">${petData.rarity.name}</span>
                </div>
                 <div class="stat-row">
                    <span class="stat-label">Body Shape:</span>
                    <span class="stat-value">${petData.bodyShape}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Accessory:</span>
                    <span class="stat-value">${petData.accessory}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Personality:</span>
                    <span class="stat-value">${petData.personality}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Special Trait:</span>
                    <span class="stat-value">${petData.specialTrait}</span>
                </div>
                 <div class="stat-row">
                    <span class="stat-label">Seed:</span>
                    <span class="stat-value">${petData.seed}</span>
                </div>
            </div>
        `;

        initThreeJS();
        createPetMesh(petData);
        animate();
    }


    // --- THREE.JS 3D RENDERING ---

    function initThreeJS() {
        const container = ui.petCanvas.parentElement;
        if (!container) return;

        if (renderer) {
            renderer.dispose();
            if (animationId) cancelAnimationFrame(animationId);
        }

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xb3d9ff);

        camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 1, 8); // Zoomed out slightly
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ canvas: ui.petCanvas, antialias: true, preserveDrawingBuffer: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);
    }
    
    function createPetMesh(data) {
        if (petGroup) scene.remove(petGroup);
        petGroup = new THREE.Group();

        let petMaterial;
        if (data.rarity.color === 'rainbow') {
            petMaterial = new THREE.MeshNormalMaterial();
        } else {
            petMaterial = new THREE.MeshStandardMaterial({ color: data.rarity.color, roughness: 0.4, metalness: 0.1 });
        }
        
        if (data.specialTrait === 'Stealth' && data.rarity.color !== 'rainbow') {
            petMaterial.transparent = true;
            petMaterial.opacity = 0.4;
        }

        // --- BODY SHAPE LOGIC ---
        switch(data.bodyShape) {
            case "Wyrm":
                for (let i = 0; i < 5; i++) {
                    const segment = new THREE.Mesh(new THREE.SphereGeometry(0.7 - i * 0.05, 16, 16), petMaterial);
                    segment.position.x = (i * -1.0) + 2.0;
                    segment.position.y = Math.sin(i * 0.9) * 0.3;
                    petGroup.add(segment);
                }
                petGroup.position.y = 0;
                break;
            
            case "Critter":
                const body_c = new THREE.Mesh(new THREE.SphereGeometry(1.2, 32, 16), petMaterial);
                body_c.scale.y = 1.3;
                body_c.position.y = 0;
                const head_c = new THREE.Mesh(new THREE.SphereGeometry(0.9, 32, 16), petMaterial);
                head_c.position.y = 1.6;
                petGroup.add(body_c, head_c);
                break;

            case "Blob":
            default:
                const blob_b = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 24), petMaterial);
                blob_b.position.y = 0.5;
                petGroup.add(blob_b);
                break;
        }

        // --- EYES ---
        const eyeGeometry = new THREE.SphereGeometry(0.15, 12, 8);
        let eyeMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });

        if (data.specialTrait === 'Glowing Eyes') {
            eyeMaterial = new THREE.MeshBasicMaterial({
                color: 0xffff00,
                emissive: 0xffff00,
                emissiveIntensity: 1
            });
        }
        
        let leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
        let rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
        leftEye.name = "leftEye";
        rightEye.name = "rightEye";
        
        switch(data.bodyShape) {
            case "Wyrm":
                leftEye.position.set(-1.6, 0.2, 0.6);
                rightEye.position.set(-1.6, 0.2, -0.6);
                petGroup.rotation.y = Math.PI / 2;
                break;
            case "Critter":
                leftEye.position.set(-0.35, 1.8, 0.7);
                rightEye.position.set(0.35, 1.8, 0.7);
                break;
            case "Blob":
            default:
                leftEye.position.set(-0.4, 0.8, 1.2);
                rightEye.position.set(0.4, 0.8, 1.2);
                break;
        }
        petGroup.add(leftEye, rightEye);
        
        // --- SPECIAL TRAIT EFFECTS ---
        if (data.specialTrait === 'Sparkles') {
            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCnt = 150;
            const posArray = new Float32Array(particlesCnt * 3);
            for (let i = 0; i < particlesCnt * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 5;
            }
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMaterial = new THREE.PointsMaterial({ size: 0.06, color: 0xFFD700, transparent: true });
            const sparkleParticles = new THREE.Points(particlesGeometry, particlesMaterial);
            sparkleParticles.name = 'sparkles';
            petGroup.add(sparkleParticles);
        }
        
        if (data.specialTrait === 'Code Aura') {
            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCnt = 200;
            const posArray = new Float32Array(particlesCnt * 3);
             for (let i = 0; i < particlesCnt * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 6;
            }
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMaterial = new THREE.PointsMaterial({ size: 0.05, color: 0x00ff00, transparent: true });
            const codeParticles = new THREE.Points(particlesGeometry, particlesMaterial);
            codeParticles.name = 'codeAura';
            petGroup.add(codeParticles);
        }

        addAccessory(data.accessory, data.bodyShape);
        scene.add(petGroup);
    }

    function addAccessory(accessory, bodyShape) {
        const existingAccessory = petGroup.getObjectByName("accessory");
        if(existingAccessory) petGroup.remove(existingAccessory);

        let accessoryMesh;
        let headYOffset = 0;

        switch(bodyShape) {
            case "Critter": headYOffset = 2.4; break;
            case "Blob": headYOffset = 1.8; break;
            case "Wyrm": headYOffset = 0.5; break; // Relative to front segment
        }

        switch(accessory) {
            case "Top Hat":
                const hatGroup = new THREE.Group();
                const brim = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.1, 32), new THREE.MeshStandardMaterial({color: 0x111111}));
                const top = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.8, 32), new THREE.MeshStandardMaterial({color: 0x111111}));
                top.position.y = 0.45;
                hatGroup.add(brim, top);
                accessoryMesh = hatGroup;
                accessoryMesh.position.y = headYOffset;
                if(bodyShape === 'Wyrm') accessoryMesh.position.x = 2.0;
                break;
            case "Crown":
                accessoryMesh = new THREE.Mesh(new THREE.TorusGeometry(0.6, 0.1, 8, 20), new THREE.MeshStandardMaterial({color: 0xFFD700, metalness: 0.8, roughness: 0.3}));
                accessoryMesh.position.y = headYOffset + 0.1;
                if(bodyShape === 'Wyrm') accessoryMesh.position.x = 2.0;
                accessoryMesh.rotation.x = Math.PI / 2;
                break;
            case "Halo":
                 accessoryMesh = new THREE.Mesh(new THREE.TorusGeometry(0.7, 0.05, 16, 100), new THREE.MeshStandardMaterial({color: 0xFFFFE0, emissive: 0xFFFFE0, emissiveIntensity: 1}));
                 accessoryMesh.position.y = headYOffset + 0.3;
                 if(bodyShape === 'Wyrm') accessoryMesh.position.x = 2.0;
                 accessoryMesh.rotation.x = Math.PI / 2;
                 break;
            case "Sunglasses":
                const glassesGroup = new THREE.Group();
                const lensMat = new THREE.MeshBasicMaterial({color: 0x111111});
                const lenseL = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.3, 0.1), lensMat);
                lenseL.position.x = -0.4;
                const lenseR = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.3, 0.1), lensMat);
                lenseR.position.x = 0.4;
                glassesGroup.add(lenseL, lenseR);
                accessoryMesh = glassesGroup;
                if (bodyShape === 'Critter') accessoryMesh.position.set(0, 1.8, 0.8);
                else if (bodyShape === 'Blob') accessoryMesh.position.set(0, 0.8, 1.3);
                else if (bodyShape === 'Wyrm') accessoryMesh.position.set(2.0, 0.3, 0);
                break;
            case "Jetpack":
                 const packGroup = new THREE.Group();
                 const tankMat = new THREE.MeshStandardMaterial({color: 0xC0C0C0, metalness: 1});
                 const tankL = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 1, 16), tankMat);
                 tankL.position.x = -0.5;
                 const tankR = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 1, 16), tankMat);
                 tankR.position.x = 0.5;
                 packGroup.add(tankL, tankR);
                 accessoryMesh = packGroup;
                 accessoryMesh.position.set(0, 0, -1.5);
                 accessoryMesh.rotation.x = Math.PI / 16;
                 if(bodyShape === 'Wyrm') accessoryMesh.position.set(0, 0, -0.8);
                 break;
        }

        if (accessoryMesh) {
            accessoryMesh.name = "accessory";
            petGroup.add(accessoryMesh);
        }
    }

    function animate() {
        animationId = requestAnimationFrame(animate);
        if (petGroup && !isDragging) {
            petGroup.rotation.y += 0.005;
        }
        
        let baseY = 0;
        if (currentPetData && currentPetData.specialTrait === 'Floating') {
            baseY = Math.sin(Date.now() * 0.002) * 0.2;
        }

        if (petIsHopping) {
            const elapsed = Date.now() - hopStartTime;
            if (elapsed > 300) { // 300ms hop duration
                petIsHopping = false;
                if (petGroup) petGroup.position.y = baseY;
            } else {
                // simple parabolic hop animation
                const hopProgress = elapsed / 300;
                const hopHeight = 0.5;
                if (petGroup) petGroup.position.y = baseY + hopHeight * Math.sin(hopProgress * Math.PI);
            }
        } else {
            if (petGroup) petGroup.position.y = baseY;
        }
        
        if (currentPetData && currentPetData.bodyShape === 'Blob') {
            const scaleFactor = Math.sin(Date.now() * 0.003) * 0.05 + 1;
            petGroup.scale.set(scaleFactor, 1 / scaleFactor, scaleFactor);
        } else if (currentPetData && currentPetData.bodyShape === 'Wyrm') {
             petGroup.children.forEach((child, index) => {
                if(child.isMesh) child.position.y = Math.sin(Date.now() * 0.002 + index * 0.9) * 0.3;
             });
        } else {
            if(petGroup) petGroup.scale.set(1, 1, 1);
        }

        if (currentPetData && currentPetData.specialTrait === 'Glowing Eyes') {
            const leftEye = petGroup.getObjectByName('leftEye');
            const rightEye = petGroup.getObjectByName('rightEye');
            if (leftEye && rightEye) {
                const intensity = Math.abs(Math.sin(Date.now() * 0.004)) * 1.5 + 0.8;
                leftEye.material.emissiveIntensity = intensity;
                rightEye.material.emissiveIntensity = intensity;
            }
        }
        
        if (currentPetData && currentPetData.specialTrait === 'Sparkles') {
            const sparkles = petGroup.getObjectByName('sparkles');
            if (sparkles) {
                sparkles.rotation.y += 0.008;
                sparkles.material.opacity = Math.abs(Math.sin(Date.now() * 0.0015));
            }
        }
        
         if (currentPetData && currentPetData.specialTrait === 'Code Aura') {
            const codeAura = petGroup.getObjectByName('codeAura');
            if (codeAura) {
                codeAura.rotation.y -= 0.005;
                codeAura.rotation.x += 0.002;
                codeAura.material.opacity = Math.abs(Math.sin(Date.now() * 0.002));
            }
        }

        if (currentPetData && currentPetData.specialTrait === 'Glitching' && Math.random() < 0.1) {
            const originalX = petGroup.position.x;
            petGroup.position.x += (Math.random() - 0.5) * 0.5;
            setTimeout(() => { if (petGroup) petGroup.position.x = originalX; }, 60);
        }
        
        renderer.render(scene, camera);
    }

    // --- UI & EVENT HANDLERS ---
    
    document.addEventListener('DOMContentLoaded', () => {
        updateClock();
        setInterval(updateClock, 1000);
        openMainWindow();
        setupDragRotation();

        // Add sound listeners
        document.querySelectorAll('.button, .window-button, .desktop-icon, .start-button').forEach(el => {
            el.addEventListener('mousedown', () => sounds.play('click'));
        });

        // Start menu logic
        const startButton = document.getElementById('startButton');
        const startMenu = document.getElementById('startMenu');
        startButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (startMenu.style.display === 'block') {
                startMenu.style.display = 'none';
            } else {
                startMenu.style.display = 'block';
            }
        });
        document.addEventListener('click', (e) => {
            if (startMenu.style.display === 'block' && !startMenu.contains(e.target) && e.target !== startButton) {
                startMenu.style.display = 'none';
            }
        });
    });

    function hideStartMenu() {
        document.getElementById('startMenu').style.display = 'none';
    }

    function bringToFront(windowEl) {
        if (!windowEl) return;
        windowEl.style.zIndex = zCounter++;
        // Make associated taskbar item look active
        document.querySelectorAll('.taskbar-item').forEach(item => item.classList.remove('active'));
        const taskbarItem = document.querySelector(`.taskbar-item[data-id="${windowEl.id}"]`);
        if (taskbarItem && !windowEl.classList.contains('minimized')) {
            taskbarItem.classList.add('active');
        }
    }

    function openMainWindow() { 
        const win = ui.mainWindow;
        win.classList.add('active'); 
        win.classList.remove('minimized');
        bringToFront(win);
        restoreWindow(win.id);
        sounds.play('click'); 

        if (!connectedWallet) {
            openConnectWalletWindow();
        }
    }
    function openHelpWindow() { 
        const win = ui.helpWindow;
        win.classList.add('active'); 
        win.classList.remove('minimized');
        bringToFront(win);
        restoreWindow(win.id);
        sounds.play('click'); 
    }
    function openAboutWindow() { 
        const win = ui.aboutWindow;
        win.classList.add('active'); 
        win.classList.remove('minimized');
        bringToFront(win);
        restoreWindow(win.id);
        sounds.play('click'); 
    }
    function openRoadmapWindow() {
        const win = ui.roadmapWindow;
        win.classList.add('active');
        win.classList.remove('minimized');
        bringToFront(win);
        restoreWindow(win.id);
        sounds.play('click');
    }
    function openGalleryWindow() {
        const win = ui.galleryWindow;
        if (win.classList.contains('active')) {
            bringToFront(win);
            return;
        }
        win.classList.add('active'); 
        win.classList.remove('minimized');
        bringToFront(win);
        populateGallery();
        restoreWindow(win.id);
        sounds.play('click'); 
    }
    function closeWindow(id) { 
        const windowEl = document.getElementById(id);
        windowEl.classList.remove('active'); 
        if (!windowEl.classList.contains('minimized')) {
           const taskbarItem = document.querySelector(`.taskbar-item[data-id="${id}"]`);
           if (taskbarItem) taskbarItem.remove();
        }
    }

    function minimizeWindow(id) {
        const windowEl = document.getElementById(id);
        if (!windowEl || !windowEl.classList.contains('active')) return;

        const title = windowEl.querySelector('.window-title').textContent.trim();
        if (document.querySelector(`.taskbar-item[data-id="${id}"]`)) return; // Already minimized

        windowEl.classList.add('minimized');
        
        const taskbarItem = document.createElement('button');
        taskbarItem.className = 'taskbar-item';
        taskbarItem.textContent = title;
        taskbarItem.dataset.id = id;
        taskbarItem.onclick = () => restoreWindow(id);
        
        ui.taskbarItems.appendChild(taskbarItem);
        document.querySelectorAll('.taskbar-item').forEach(item => item.classList.remove('active'));
        sounds.play('click');
    }

    function restoreWindow(id) {
        const windowEl = document.getElementById(id);
        if (!windowEl) return;
        
        windowEl.classList.remove('minimized');
        bringToFront(windowEl);
        
        const taskbarItem = document.querySelector(`.taskbar-item[data-id="${id}"]`);
        if (taskbarItem) {
            taskbarItem.remove();
        }
        sounds.play('click');
    }

    let windowDragState = { isDragging: false, target: null, offsetX: 0, offsetY: 0 };
    function startDrag(event, id) {
        const target = document.getElementById(id);
        bringToFront(target);
        windowDragState = {
            isDragging: true,
            target: target,
            offsetX: event.clientX - target.offsetLeft,
            offsetY: event.clientY - target.offsetTop,
        };
        document.addEventListener('mousemove', onWindowDrag);
        document.addEventListener('mouseup', endWindowDrag);
    }

    function onWindowDrag(event) {
        if (!windowDragState.isDragging) return;
        windowDragState.target.style.left = `${event.clientX - windowDragState.offsetX}px`;
        windowDragState.target.style.top = `${event.clientY - windowDragState.offsetY}px`;
    }

    function endWindowDrag() {
        windowDragState.isDragging = false;
        document.removeEventListener('mousemove', onWindowDrag);
        document.removeEventListener('mouseup', endWindowDrag);
    }
    
    // --- Manual Pet Rotation ---
    function setupDragRotation() {
        ui.petViewer.addEventListener('mousedown', e => {
            isDragging = true;
            previousMousePosition.x = e.clientX;
            previousMousePosition.y = e.clientY;
        });
        
        ui.petViewer.addEventListener('mousemove', e => {
            if (!isDragging || !petGroup) return;
            const deltaX = e.clientX - previousMousePosition.x;
            petGroup.rotation.y += deltaX * 0.01;
            previousMousePosition.x = e.clientX;
        });

        ui.petViewer.addEventListener('mouseup', () => { isDragging = false; });
        ui.petViewer.addEventListener('mouseleave', () => { isDragging = false; });
    }

    function updateClock() {
        ui.clock.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function showNotification(message) {
        ui.notificationText.textContent = message;
        ui.notification.style.display = 'block';
        setTimeout(() => { ui.notification.style.display = 'none'; }, 4000);
    }

    function showError(message) {
        ui.statusText.innerHTML = `<span class="error-text">ERROR: ${message}</span>`;
    }

    async function updateProgress(progress, text) {
        ui.progressBar.style.width = `${progress}%`;
        ui.statusText.textContent = text;
        return new Promise(resolve => setTimeout(resolve, 250));
    }
    
    function sharePet() {
        if (!currentPetData) return;
        const text = `I got a ${currentPetData.rarity.name} ${currentPetData.bodyShape} pet with a ${currentPetData.accessory} and the ${currentPetData.personality} personality. Generate your own Pet on PetOS!`;
        const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
    }

    function copyPetData() {
        if (!currentPetData) return;
        const dataString = JSON.stringify(currentPetData, null, 2);
        navigator.clipboard.writeText(dataString).then(() => {
            showNotification('Pet data copied to clipboard!');
        }, () => {
            showError('Failed to copy data.');
        });
    }

    function downloadPetImage() {
        if (!renderer) return;
        const dataURL = renderer.domElement.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `${currentPetData.walletAddress.substring(0,10)}_pet.png`;
        link.href = dataURL;
        link.click();
    }

    function sharePetCard() {
        if (!currentPetData || !renderer) return;
        // Create an off-screen canvas
        const cardWidth = 600, cardHeight = 400;
        const cardCanvas = document.createElement('canvas');
        cardCanvas.width = cardWidth;
        cardCanvas.height = cardHeight;
        const ctx = cardCanvas.getContext('2d');

        // Background
        ctx.fillStyle = '#e3f4ff';
        ctx.fillRect(0, 0, cardWidth, cardHeight);
        // Card border
        ctx.strokeStyle = '#245ddb';
        ctx.lineWidth = 6;
        ctx.strokeRect(0, 0, cardWidth, cardHeight);

        // Draw pet image from renderer
        const petImg = new Image();
        petImg.src = renderer.domElement.toDataURL('image/png');
        petImg.onload = function() {
            // Pet image area
            ctx.save();
            ctx.beginPath();
            ctx.arc(160, 180, 120, 0, 2 * Math.PI);
            ctx.closePath();
            ctx.clip();
            ctx.drawImage(petImg, 40, 60, 240, 240);
            ctx.restore();

            // Pet name
            ctx.font = 'bold 24px Tahoma, Arial, sans-serif';
            ctx.fillStyle = '#245ddb';
            ctx.textAlign = 'left';
            ctx.fillText(currentPetData.name, 300, 100);

            // Stats
            ctx.font = '16px Tahoma, Arial, sans-serif';
            ctx.fillStyle = '#222';
            let y = 140;
            const statPad = 34;
            function stat(label, value, color) {
                ctx.font = 'bold 15px Tahoma, Arial, sans-serif';
                ctx.fillStyle = '#87875d';
                ctx.fillText(label + ':', 300, y);
                ctx.font = '16px Tahoma, Arial, sans-serif';
                ctx.fillStyle = color || '#222';
                ctx.fillText(value, 420, y);
                y += statPad;
            }
            // Rarity color
            let rarityColor = '#808080';
            switch(currentPetData.rarity.name) {
                case 'Uncommon': rarityColor = '#1eff00'; break;
                case 'Rare': rarityColor = '#0080ff'; break;
                case 'Epic': rarityColor = '#a335ee'; break;
                case 'Legendary': rarityColor = '#ff8000'; break;
                case 'Mythic': rarityColor = '#ff0080'; break;
            }
            stat('Rarity', currentPetData.rarity.name, rarityColor);
            stat('Body Shape', currentPetData.bodyShape);
            stat('Accessory', currentPetData.accessory);
            stat('Personality', currentPetData.personality);
            stat('Special Trait', currentPetData.specialTrait);
            stat('Owner', currentPetData.walletAddress.substring(0, 10) + '...');

            // Footer
            ctx.font = 'italic 13px Tahoma, Arial, sans-serif';
            ctx.fillStyle = '#245ddb';
            ctx.textAlign = 'center';
            ctx.fillText('PetOS  |  pet-os.app', cardWidth/2, cardHeight - 24);
            ctx.font = '32px serif';
            ctx.fillText('üêæ', 60, cardHeight - 30);

            // Download
            const link = document.createElement('a');
            link.download = `${currentPetData.walletAddress.substring(0,10)}_pet_card.png`;
            link.href = cardCanvas.toDataURL('image/png');
            link.click();
        };
    }

    function populateGallery() {
        ui.galleryContent.innerHTML = ''; // Clear previous content
        const pets = Object.values(petRegistry);

        if (pets.length === 0) {
            ui.galleryContent.innerHTML = '<p style="padding: 12px; text-align: center; font-size: 11px;">No pets generated yet. Go make one!</p>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'gallery-grid';

        pets.sort((a, b) => a.walletAddress.localeCompare(b.walletAddress)).forEach(petData => {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.onclick = () => {
                openMainWindow();
                displayPet(petData);
                closeWindow('galleryWindow');
                sounds.play('click');
            };

            const name = document.createElement('div');
            name.className = 'gallery-item-name';
            name.textContent = `${petData.walletAddress.substring(0,8)}...`;
            name.title = petData.name;

            const rarity = document.createElement('div');
            rarity.className = `gallery-item-rarity rarity-${petData.rarity.name.toLowerCase()}`;
            rarity.textContent = petData.rarity.name;

            item.appendChild(name);
            item.appendChild(rarity);
            grid.appendChild(item);
        });

        ui.galleryContent.appendChild(grid);
    }

    function triggerInteraction() {
        if (!petGroup || petIsHopping) return;
        sounds.play('interaction');
        petIsHopping = true;
        hopStartTime = Date.now();
    }

    // --- UTILITY FUNCTIONS ---

    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash |= 0; // Convert to 32bit integer
        }
        return hash;
    }

  </script>
</body>
</html>
